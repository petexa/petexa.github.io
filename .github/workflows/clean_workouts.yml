name: Clean Workouts Data

on:
  push:
    branches:
      - main
    paths:
      - 'data/workouts_table.csv'
      - 'scripts/clean_workouts.py'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no file changes)'
        required: false
        type: boolean
        default: false
      max_ai_requests:
        description: 'Maximum AI API requests'
        required: false
        type: number
        default: 50

jobs:
  clean-workouts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 tqdm
          # Install openai only if API key is available
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            pip install openai
          fi
      
      - name: Check for OPENAI_API_KEY
        id: check-api-key
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "ai_enabled=true" >> $GITHUB_OUTPUT
            echo "‚úÖ OPENAI_API_KEY is set - AI features enabled"
          else
            echo "ai_enabled=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è OPENAI_API_KEY not set - falling back to web-only heuristics"
          fi
      
      - name: Create cache directory
        run: mkdir -p .cache
      
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: workout-cleaning-cache-${{ hashFiles('data/workouts_table.csv') }}
          restore-keys: |
            workout-cleaning-cache-
      
      - name: Run workout data cleaner
        id: clean
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          MAX_AI="${{ github.event.inputs.max_ai_requests }}"
          MAX_AI_FLAG=""
          if [ -n "$MAX_AI" ] && [ "$MAX_AI" != "50" ]; then
            MAX_AI_FLAG="--max-ai-requests $MAX_AI"
          fi
          
          python scripts/clean_workouts.py \
            --input data/workouts_table.csv \
            --out data/workouts_table.csv \
            --audit workouts_table_audit.csv \
            --report validation_report.md \
            --replace-input \
            $DRY_RUN_FLAG \
            $MAX_AI_FLAG \
            --verbose
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cleaning-outputs
          path: |
            workouts_table_audit.csv
            validation_report.md
          retention-days: 30
      
      - name: Display validation report
        if: always()
        run: |
          echo "### Workout Data Cleaning Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f validation_report.md ]; then
            cat validation_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Validation report not found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check for data changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain data/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù Data files were modified during cleaning"
            git diff --stat data/
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No data changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add cleaned CSV (source of truth) and regenerated JSON
          git add data/workouts_table.csv
          git add data/workouts_table.json
          git add workouts_table_audit.csv || true
          git add validation_report.md || true
          
          # Commit with descriptive message
          git commit -m "üßπ Auto-clean workout data [skip ci]

          - CSV is source of truth
          - JSON regenerated from CSV
          - Converted units to kg
          - Removed unused columns
          - See validation_report.md for details"
          
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.clean.outcome }}" == "failure" ]; then
            echo "‚ùå Cleaning script failed - check logs for details"
            exit 1
          else
            echo "‚úÖ Cleaning completed successfully"
          fi
